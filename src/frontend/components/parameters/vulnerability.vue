<template>
  <v-card
    title="Vulnerabilities"
    :prepend-icon="enums.findings.Vulnerability.icon"
    variant="text"
  >
    <template #text>
      <BaseTagInput
        v-if="done"
        ref="tagInput"
        class="mt-4"
        :value="Object.keys(cves)"
        label="CVEs"
        icon="mdi-identifier"
        :validate="validate.cve"
        @new-value="(value) => add(value)"
        @remove-value="(value) => remove(value)"
      />
    </template>
  </v-card>
</template>

<script setup lang="ts">
const tagInput = ref(null);
const route = useRoute();
const validate = useValidation();
const enums = useEnums();
const cves = ref({});
const done = ref(false);
const api = useApi("/api/parameters/vulnerabilities/", true, "Vulnerability");
api.list({ target: route.params.target_id }, true).then((response) => {
  for (const vulnerability of response.items) {
    cves.value[vulnerability.cve] = vulnerability.id;
  }
  done.value = true;
});

function remove(cve: string): void {
  api
    .remove(cves.value[cve])
    .then(() => {
      /* eslint-disable-next-line @typescript-eslint/no-dynamic-delete */
      delete cves.value[cve];
    })
    .catch(() => tagInput.value.addTag(cve));
}

function add(cve: string): void {
  api
    .create({ target: route.params.target_id, cve: cve })
    .then((response) => (cves.value[cve] = response.id))
    .catch(() => tagInput.value.removeTag(cve));
}
</script>
