<template>
  <v-form v-model="valid" @submit.prevent="submit()">
    <v-container fluid>
      <v-row>
        <v-alert
          v-if="cvecrowd.api_token === null"
          color="info"
          icon="$info"
          variant="tonal"
          text="You can get an API key for free by just creating an account in the platform. You can configure the days span from when trending CVEs will be checked, and you can also decide to run the integration after each execution or just monitor your CVEs periodically"
        />
        <v-alert
          v-if="cvecrowd.api_token !== null"
          color="info"
          icon="$info"
          variant="tonal"
          text="You can configure the days span from when trending CVEs will be checked, and you can also decide to run the integration after each execution or just monitor your CVEs periodically"
        />
      </v-row>
      <v-row class="mt-8" justify="center" dense>
        <v-text-field
          v-model="cvecrowd.api_token"
          type="password"
          label="CVE Crowd API key"
          prepend-inner-icon="mdi-key"
          variant="outlined"
          :rules="[
            (k) => !k || validate.secret.test(k.trim()) || 'Invalid API key',
          ]"
          validate-on="input"
          clearable
          @update:model-value="disabled = false"
        />
      </v-row>
      <v-row justify="space-around" dense>
        <v-col cols="5">
          <VNumberInput
            v-model="cvecrowd.trending_span_days"
            control-variant="split"
            label="Trending Span Days"
            inset
            variant="outlined"
            :max="7"
            :min="1"
            @update:model-value="disabled = false"
          />
        </v-col>
        <v-col cols="4">
          <v-switch
            v-model="cvecrowd.execute_per_execution"
            color="green"
            :label="
              cvecrowd.execute_per_execution
                ? 'Executions & Monitor'
                : 'Only Monitor'
            "
            @update:model-value="disabled = false"
          />
        </v-col>
      </v-row>
      <v-btn
        color="green"
        size="large"
        variant="tonal"
        text="Save"
        type="submit"
        class="mt-5"
        :disabled="disabled"
        block
        autofocus
      />
    </v-container>
  </v-form>
</template>

<script setup lang="ts">
import { VNumberInput } from "vuetify/labs/VNumberInput";
const props = defineProps({
  api: Object,
  data: Object,
});
const emit = defineEmits(["loading", "reloadData"]);

const valid = ref(true);
const validate = ref(useValidation());
const disabled = ref(true);

const cvecrowd = ref({});
watch(
  () => props.data,
  () => {
    cvecrowd.value = props.data;
  },
);

function submit() {
  if (valid.value) {
    const body = {
      trending_span_days: cvecrowd.value.trending_span_days,
      execute_per_execution: cvecrowd.value.execute_per_execution,
      api_token:
        !cvecrowd.value.api_token ||
        cvecrowd.value.api_token !== "*".repeat(cvecrowd.value.api_token.length)
          ? cvecrowd.value.api_token
          : undefined,
    };
    emit("loading", true);
    props.api.update(body, 1).then((response) => {
      cvecrowd.value = response;
      emit("reloadData", response);
      emit("loading", false);
      disabled.value = true;
    });
  }
}
</script>
