<template>
  <IntegrationDialog
    :api="integrationApi"
    :integration="integration"
    :is-available="isAvailable"
    color="green-darken-3"
    :loading="loading"
    @close-dialog="$emit('closeDialog')"
  >
    <v-form v-model="valid" @submit.prevent="submit()">
      <v-container fluid>
        <v-row class="mb-3" justify="center">
          <v-col cols="10">
            <v-text-field
              v-model="apiToken"
              type="password"
              label="CVE Crowd API key"
              prepend-inner-icon="mdi-key"
              variant="outlined"
              :rules="[
                (k) =>
                  !k || validate.secret.test(k.trim()) || 'Invalid API key',
              ]"
              validate-on="input"
              clearable
              @update:model-value="disabled = false"
            />
          </v-col>
        </v-row>
        <v-row justify="space-around" dense>
          <v-col cols="4">
            <VNumberInput
              v-model="trendingSpanDays"
              control-variant="split"
              label="Trending Span Days"
              inset
              variant="outlined"
              :max="7"
              :min="1"
              @update:model-value="disabled = false"
            />
          </v-col>
          <v-col cols="5">
            <v-switch
              v-model="executePerExecution"
              color="green"
              :label="
                executePerExecution
                  ? 'After executions & Monitor'
                  : 'Only Monitor'
              "
              @update:model-value="disabled = false"
            />
          </v-col>
        </v-row>
        <UtilsSubmit
          color="green-darken-3"
          text="Save"
          :disabled="disabled"
          class="mt-5"
        />
      </v-container>
    </v-form>
  </IntegrationDialog>
</template>

<script setup lang="ts">
import { VNumberInput } from "vuetify/labs/VNumberInput";
defineProps({
  integrationApi: Object,
  integration: Object,
});
const emit = defineEmits(["closeDialog"]);
const api = useApi("/api/cvecrowd/", true, "CVE Crowd");
const valid = ref(true);
const validate = ref(useValidation());
const disabled = ref(true);
const loading = ref(true);

const isAvailable = ref(false);
const apiToken = ref(null);
const trendingSpanDays = ref(7);
const executePerExecution = ref(true);

api.get(1).then((response) => {
  loadData(response);
  loading.value = false;
});

function loadData(data: object): void {
  isAvailable.value = data.is_available;
  apiToken.value = data.api_token;
  trendingSpanDays.value = data.trending_span_days;
  executePerExecution.value = data.execute_per_execution;
}

function submit(): void {
  if (valid.value) {
    loading.value = true;
    api
      .update(
        {
          trending_span_days: trendingSpanDays.value,
          execute_per_execution: executePerExecution.value,
          api_token:
            !apiToken.value ||
            apiToken.value !== "*".repeat(apiToken.value.length)
              ? apiToken.value !== null
                ? apiToken.value.trim()
                : null
              : undefined,
        },
        1,
      )
      .then((response) => {
        loadData(response);
        loading.value = false;
        disabled.value = true;
        if (response.is_available) {
          emit("closeDialog");
        }
      });
  }
}
</script>
